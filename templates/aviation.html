{% extends "layout.html" %}
{% block title %}
Aviation (A320) Themed Planner
{% endblock %}
{% block main %}
<img src="../static/background.jpg" style="position: absolute; z-index: -1; height: 100vh; width: 100vw;">
<div class="container" style="margin: 0">
    <div class="row">
        <div id="power" class="overlay">
            <!-- <button style="margin: 15vh 8vh;" class="overlay">ON</button>
            <button style="margin-left: 27vh; margin-top: 25vh;" class="overlay">ON</button> -->
            <img class="pwh" style="height: 25vh; margin-left: 0vh; position: absolute;"
                src="../static/aviation/power/bat.png">
            <img class="pwv" style="height: 50vh; margin-left: 20vh; position: absolute;"
                src="../static/aviation/power/apu.png">
            <img class="pwh" style="height: 25vh; margin-left: 30vh; position: absolute;"
                src="../static/aviation/power/eng.png">
        </div>
        <div id="mcdu">
            <!-- 10 Side Buttons -->
            <button id="l1" class="mcduSideButton overlay" style="margin-top: 8vh; margin-left: 1vh;"></button>
            <button id="l2" class="mcduSideButton overlay" style="margin-top: 13vh; margin-left: 1vh;"></button>
            <button id="l3" class="mcduSideButton overlay" style="margin-top: 17vh; margin-left: 1vh;"></button>
            <button id="l4" class="mcduSideButton overlay" style="margin-top: 22vh; margin-left: 1vh;"></button>
            <button id="l5" class="mcduSideButton overlay" style="margin-top: 27vh; margin-left: 1vh;"></button>
            <button id="r1" class="mcduSideButton overlay" style="margin-top: 8vh; margin-left: 44vh;"></button>
            <button id="r2" class="mcduSideButton overlay" style="margin-top: 13vh; margin-left: 44vh;"></button>
            <button id="r3" class="mcduSideButton overlay" style="margin-top: 17vh; margin-left: 44vh;"></button>
            <button id="r4" class="mcduSideButton overlay" style="margin-top: 22vh; margin-left: 44vh;"></button>
            <button id="r5" class="mcduSideButton overlay" style="margin-top: 27vh; margin-left: 44vh;"></button>

            <!-- 6 Menu Buttons -->
            <button id="init" class="menuButton overlay" style="margin-top: 37vh; margin-left: 6vh;"></button>
            <button id="perf" class="menuButton overlay" style="margin-top: 37vh; margin-left: 12vh;"></button>
            <button id="fuel" class="menuButton overlay" style="margin-top: 37vh; margin-left: 19vh;"></button>
            <button id="dir" class="menuButton overlay" style="margin-top: 37vh; margin-left: 25vh;"></button>
            <button id="f_pln" class="menuButton overlay" style="margin-top: 37vh; margin-left: 31vh;"></button>
            <button id="t/oappr" class="menuButton overlay" style="margin-top: 37vh; margin-left: 37vh;"></button>

            <!-- The Letters... Oh this is going to take a while ... Nevermind, I did it using javascript-->
            <!-- The Four arrows... This is easier to do with HTML -->
            <button class="overlay mcduArrow" id="left" style="margin-top: 45vh; margin-left: 5.5vh;"></button>
            <button class="overlay mcduArrow" id="up" style="margin-top: 45vh; margin-left: 12vh;"></button>
            <button class="overlay mcduArrow" id="right" style="margin-top: 49.5vh; margin-left: 5.5vh;"></button>
            <button class="overlay mcduArrow" id="down" style="margin-top: 49.5vh; margin-left: 12vh;"></button>
            <input id="input" class="overlay display"
                style="z-index: 11; margin-top: 29vh; margin-left: 7.5vh; width: 35vh; height:4vh; border-radius: 10vh;" />
            <img style="height: 80vh; position: absolute;" src="../static/aviation/fms/mcdu.png">
            <button id="reset" class="overlay" style="color:white; z-index: 12; margin-left: 80vh;">Reset</button>
            <button id="loadwaypoint" class="overlay" style="color:white; z-index: 12;">Load Waypoint Data</button>
            <p1 id="pageName" class="overlay display"
                style="width: 50vh; font-size: 2vh; margin-top: 4vh; text-align: center;">
            </p1>
        </div>
        <div style="flex: auto;" id="status">
        </div>
        <div id="aviationThemeSettings">
            <p1 style="color: white;">Save State of Panel</p1>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="initSave">
                <label class="form-check-label" style="color:white" for="flexCheckDefault">
                    INIT
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="perfSave">
                <label class="form-check-label" style="color:white" for="flexCheckDefault">
                    PERF
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="fuelSave">
                <label class="form-check-label" style="color:white" for="flexCheckDefault">
                    FUEL
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="dirSave">
                <label class="form-check-label" style="color:white" for="flexCheckDefault">
                    DIR
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="f_plnSave">
                <label class="form-check-label" style="color:white" for="flexCheckDefault">
                    F_PLN
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="t/oapprSave">
                <label class="form-check-label" style="color:white" for="flexCheckDefault">
                    T/O APPR
                </label>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block script %}
<script>
    position = 0;
    theme = "aviation";
    currentDisplay = {
        "init": {
            "left": [

            ],
            "right": [

            ],
        },
        "perf": {

        },
        "initialized": [

        ],
        "backendActionRequest": "",
        "active": "",
        "info": [],
        "saves": []
    }


    $.ajax({
        url: "/api/aviation/mcduLoad",
        method: "GET",
        success: function (response) {
            console.log(response["Status"])
            if (response["Status"] != "no data") {
                currentDisplay = response["aviation"]
                // Initialize Saving States
                for (i = 0; i < currentDisplay.saves.length; i++) {
                    console.log(currentDisplay.saves[i])
                    if (currentDisplay.saves[i] != "t/oapprSave") {
                        $("#" + currentDisplay.saves[i]).prop("checked", true);
                    }
                    else {
                        toappr = document.getElementById("t/oapprSave")
                        toappr.checked = true
                    }
                }
                reloadContent();
                console.log(currentDisplay.active)

            }
            else {

                for (const [key, value] of Object.entries(airplaneModes)) {
                    currentDisplay[key] = airplaneModes[key]
                }
            }
        }
    })

    var isMobile = false; //initiate as false
    // device detection
    if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)
        || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0, 4))) {
        isMobile = true;
    }
    if (isMobile) {
        // Place UI as in the following diagram: mobileView.jpg
        // Move the mcdu div all the way to the right by setting auto flex to pusher
        //dimension in order of [margintop, marginleft, width, height] 
        dimensions = [["85", "1.5", "7", "7"], ["85", "9", "7", "7"], ["86", "22", "3.5", "3.5"], ["91.5", "22", "3.5", "3.5"], ["85", "31", "7", "7"], ["85", "38.5", "7", "7"]]
        ids = ["bat1", "bat2", "apuMaster", "apuStart", "eng1", "eng2"]
        for (i = 0; i < 6; i++) {
            $(".pwh").height("10vh");
            $(".pwv").height("15vh");
            $(".pwh, .pwv").css("margin-top", "82vh");
            const button = document.createElement("button")
            console.log(dimensions[i][1])
            button.style.width = dimensions[i][2] + "vh";
            button.style.height = dimensions[i][3] + "vh";
            button.style.marginTop = dimensions[i][0] + "vh";
            button.style.marginLeft = dimensions[i][1] + "vh";
            button.style.position = "absolute";
            button.style.background = "transparent";
            button.style.border = "none";
            button.style.color = "green";
            button.id = ids[i];
            button.style.fontSize = "1vh";
            button.classList.add("powerButtons")
            const element = document.getElementById("power")
            element.appendChild(button)
        }
    }
    //Very Important - variables for mcdu!

    const airplaneModes = {
        "init": {
            "left": [
                { "rte": "INPUT TARGET" },
                { "altn": "INPUT SECONDARY TARGET" },
                { "flt nbr": "INPUT ANY NUMBER YOU WANT" },
                { "cost index": "INPUT SCORE MULTIPLIER" },
            ],
            "right": [
                { "from/to": "INPUT START/END TIME" }
            ]
        },
        "perf": {
            "left": [
                { "v1": "INPUT POINT TO GATHER BEFORE STARTING YOUR DAY" },
                { "vr": "INPUT POINT TO GATHER THAT WILL INITIATE TAKEOFF" },
                { "v2": "INPUT MINIMUM POINTS FOR THE DAY" },
                { "rwy": "INPUT RUNWAY NUMBER (ANYWHERE, THIS IS USELESS)" },
                { "to1/pt": "INPUT FIRST TASK/POINTS" },
            ],
            "right": [
                { "to2/pt": "INPUT SECOND TASK/POINTS" },
                { "to3/pt": "INPUT THIRD TASK/POINTS" },
                { "to4/pt": "INPUT FOURTH TASK/POINTS" },
                { "to5/pt": "INPUT FIFTH TASK/POINTS" },
                { "to6/pt": "INPUT SIXTH TASK/POINTS" },
            ]
        },
        "fuel": {
            "left": [
                { "fob": "FUEL (MINUMUM POINTS)" }
            ],
            "right": [

            ]
        },
        "dir": {
            "left": [
                { "waypoint": "INPUT WAYPOINTS/TIME" },
                { "f-pln wpt": "WAYPOINTS BELOW" },
            ],
            "right": [
                { "": "" },
                { "direct to": "CHECK TASK OFF" },
            ]
        },
        "f_pln": {
            "left": [
                { "at": "" }
            ],
            "right": [
                { "time": "" }
            ]
        },
        "t/oappr": {
            "left": [
                { "to": "take off" }
            ],
            "right": [
                { "appr": "APPROACH" }
            ]
        },
        "scroll": 0,
        "info": []
    }


    // Handle State Save Form Checks
    $("input").click(function () {
        console.log(this)
        if (this.type == "checkbox") {
            itemClicked = this.id
            status = $(this).is(":checked");
            console.log(status)
            if (status == "true") {
                if (!currentDisplay.saves.includes(itemClicked)) {
                    currentDisplay.saves.push(itemClicked)
                }
            }
            else {
                currentDisplay.saves = currentDisplay.saves.filter(e => e !== itemClicked)
                console.log(currentDisplay.saves.filter(e => e !== itemClicked));
            }
            saveContent();
        }

    })

    $("nav").removeClass("navbar-light").addClass("navbar-dark")
    $("div").removeClass("blur-content-behind")


    letters = "abcdefghijklmnopqrstuvwxyz-+/C";
    numbers = "123456789S0."

    console.log(isMobile);
    // Generate Letter Pad
    for (i = 0; i < 6; i++) {
        for (j = 0; j < 5; j++) {
            const button = document.createElement("button")
            button.style.width = "4.3vh"
            button.style.height = "3vh"
            button.style.marginTop = (i * 5 + 45.7).toString() + "vh";
            button.style.marginLeft = (j * 4.9 + 20).toString() + "vh";
            button.classList.add("overlay")
            button.classList.add("mcduLetter")
            button.id = letters[i * 5 + j];
            const element = document.getElementById("mcdu")
            element.appendChild(button)
        }
    }
    // Generate Number Pad
    for (i = 0; i < 4; i++) {
        for (j = 0; j < 3; j++) {
            const button = document.createElement("button")
            button.style.width = "4.1vh"
            button.style.height = "4.1vh"
            button.style.marginTop = (i * 4.9 + 55.5).toString() + "vh";
            button.style.marginLeft = (j * 4.9 + 5.5).toString() + "vh";
            button.style.borderRadius = "3vh";
            button.classList.add("overlay")
            button.classList.add("mcduNumber")
            button.id = numbers[i * 3 + j];
            const element = document.getElementById("mcdu")
            element.appendChild(button)
        }
    }
    // Generate Display
    for (j = 0; j < 2; j++) {
        side = "l";
        if (j == 1) {
            side = "r"
        }
        for (i = 0; i < 10; i++) {
            const lineText = document.createElement("p")
            lineText.style.width = "17vh";
            lineText.style.marginLeft = (j * 18 + 8).toString() + "vh";
            lineText.classList.add("overlay")
            lineText.style.textTransform = "uppercase";
            if (j != 0) {
                lineText.style.textAlign = "right";
            }
            if (i % 2 == 0) {
                lineText.style.color = "white";
                lineText.style.height = "2vh";
                lineText.innerHTML = side + "a" + (Math.round(i / 2) + 1)
                lineText.style.marginTop = (i * 2.35 + 7.6).toString() + "vh";
                lineText.id = side + "a" + (Math.round(i / 2) + 1);
                lineText.style.fontSize = "1.2vh";
            }
            else {
                lineText.style.color = "green";
                lineText.style.height = "3vh";
                lineText.innerHTML = side + "b" + Math.round(i / 2)
                lineText.style.marginTop = (i * 2.35 + 6.5).toString() + "vh";
                lineText.id = side + "b" + Math.round(i / 2);
                lineText.style.fontSize = "1vh";
            }
            const parent = document.getElementById("mcdu")
            parent.appendChild(lineText);
        }
    }
    $(".mcduLetter, .mcduNumber, .mcduArrow").click(function () {
        if (this.id != "C") {
            if (this.id == "S") {
                $("#input").val($("#input").val() + " ")
            }
            else {
                console.log(this.id)
                if (this.id == "down") {
                    position += 1
                    reloadContent()
                }
                else if (this.id == "up") {
                    if (position > 0)
                        position -= 1
                    reloadContent()
                }
                else {
                    $("#input").val($("#input").val() + this.id)
                }
            }
        }
        else {
            string = $("#input").val();
            if (string == "") {
                $("#input").val("CLR")
            }
            else if (string == "CLR") {
                $("#input").val("")
            }
            else if (string == "METHOD NOT ALLOWED") {
                $("#input").val("")
            }
            else {
                $("#input").val(string.substr(0, string.length - 1))
            }
        }
    })
    $(".powerButtons").click(function () {
        buttonName = this.id;
        console.log(this.id)
        $("#" + buttonName).text("ON");
    })

    // Functionalities Below
    // Initializing mcdu interface
    $(".menuButton").click(function () {
        // Set "active" to current
        requestMenu = this.id
        currentDisplay.active = requestMenu
        // Check if the page is initialized, if it is not, initialize
        if (currentDisplay.initialized.includes(requestMenu)) {
            console.log("initialized")
        }
        else {
            console.log("not initialized, initializing now")
            initialData = airplaneModes[requestMenu]
            // Update "CurrentDisplay"
            currentDisplay[requestMenu] = initialData
            currentDisplay.initialized.push(requestMenu)
        }
        console.log(airplaneModes)
        reloadContent();
        saveContent();
    })

    activeThing = ""

    function saveContent() {
        if (currentDisplay.takeoff == undefined) {
            currentDisplay.takeoff = { "left": "" }
        }
        $.ajax({
            url: "/api/aviation/mcduSave",
            data: JSON.stringify(currentDisplay),
            success: function (response) {
            },
        });
    }
    function confirmation(message, action, whatDo, information) {
        console.log(message)
        if (message == undefined) {
            // If No message, ask user what do?
            // get the bottom two displays
            rightDisplay = $("#ra5")
            leftDisplay = $("#la5")
            rightDisplay.css("color", "yellow")
            leftDisplay.css("color", "yellow")
            leftDisplay.css("font-size", "2vh")
            rightDisplay.css("font-size", "2vh")
            leftDisplay.html("erase")
            rightDisplay.html("insert")
            activeThing = information
            // The following two lines is run to clear the small text under the insert and empty, 
            // otherwise when clicking insert or complete, the program will think it's checking off another task
            $("#lb5").text("")
            $("#rb5").text("")
        }
        else {
            if (action == "insert") {
                // proceed with action
                console.log(activeThing)
                whatDo(activeThing);
            }
            // Clear the confirmation menu
            rightDisplay = $("#ra5")
            leftDisplay = $("#la5")
            rightDisplay.css("color", "white")
            leftDisplay.css("color", "white")
            leftDisplay.css("font-size", "1.2vh")
            rightDisplay.css("font-size", "1.2vh")
            leftDisplay.html("")
            rightDisplay.html("")
        }
    }

    function reloadContent() {
        requestMenu = currentDisplay.active
        // Initialize screen on the left side
        // Handle the initation if never clicked this menu
        // if (requestMenu == "f_pln") {
        //     console.log(true)
        //     $.ajax({
        //         url: "/api/get_tasks",
        //         data: JSON.stringify(currentDisplay),
        //         success: function (response) {
        //             // Get the response into MCDU Display
        //             for (i = 0; i < response.length; i++) {
        //                 // Add this specific task
        //                 // Get Time in the day
        //                 time = response[i].deadline
        //                 timeOfDay = time.substr(time.indexOf("T") + 1)
        //                 currentDisplay.f_pln.left[i + 1] = { " ": response[i]["name"] }
        //                 currentDisplay.f_pln.right[i + 1] = { " ": timeOfDay }
        //                 console.log(currentDisplay)
        //             }
        //         },
        //     });
        // }
        if (currentDisplay[requestMenu] == undefined) {
            currentDisplay[requestMenu] = airplaneModes[requestMenu]
        }
        // Change the MenuPage indication at the top
        $("#pageName").text(requestMenu)

        // Check if requestMenu.length - position + 5 is positive, if not, position = position - 1
        leftMenu = Object.keys(currentDisplay[requestMenu]["left"])
        if (Object.keys(leftMenu).length - (position + 5) < 0) {
            if (Object.keys(leftMenu).length > 5) {
                position = Object.keys(leftMenu).length - 5
            }
            else {
                position = 0;
            }
        }

        for (i = position; i < position + 5; i++) {
            if (currentDisplay[requestMenu].left[i] == undefined) {
                $("#la" + (i + 1).toString()).text("")
                $("#lb" + (i + 1).toString()).text("")
            }
            else {
                theKey = Object.keys(currentDisplay[requestMenu].left[i])[0]
                try {
                    if (airplaneModes[requestMenu].left[i][theKey].includes("INPUT")) {
                        $("#lb" + (i + 1).toString()).addClass("input")
                        $("#lb" + (i + 1).toString()).removeClass("option")
                    }
                    else {
                        $("#lb" + (i + 1).toString()).addClass("option")
                        $("#lb" + (i + 1).toString()).removeClass("input")
                    }
                }
                catch {

                }
                $("#la" + (i + 1 - position).toString()).text(theKey)
                $("#lb" + (i + 1 - position).toString()).text(currentDisplay[requestMenu].left[i][theKey])
            }
        }
        // Initialize screen on the right side
        for (i = position; i < position + 5; i++) {
            if (currentDisplay[requestMenu].right[i] == undefined) {
                $("#ra" + (i + 1).toString()).text("")
                $("#rb" + (i + 1).toString()).text("")
            }
            else {
                theKey = Object.keys(currentDisplay[requestMenu].right[i])[0]
                try {
                    if (currentDisplay[requestMenu].right[i][theKey].includes("INPUT")) {
                        $("#rb" + (i + 1).toString()).addClass("input")
                        $("#rb" + (i + 1).toString()).removeClass("option")
                    }
                    else {
                        $("#rb" + (i + 1).toString()).addClass("option")
                        $("#rb" + (i + 1).toString()).removeClass("input")
                    }
                }
                catch {

                }
                $("#ra" + (i + 1 - position).toString()).text(theKey)
                $("#rb" + (i + 1 - position).toString()).text(currentDisplay[requestMenu].right[i][theKey])
            }
        }
    }

    function getPosition(string, subString, index) {
        return string.split(subString, index).join(subString).length;
    }
    //actions with the side panels
    $(".mcduSideButton").click(function () {
        // Check display element and get which one
        requestButton = this.id
        // Check if the field is "input" class, if it is, change the bottom text
        side = requestButton.substr(0, 1)
        number = requestButton.substr(1, 1)
        display1 = $("#" + side + "a" + number)
        display2 = $("#" + side + "b" + number)
        side_full_name = "left"
        if (side == "r") {
            side_full_name = "right"
        }
        if (display2.hasClass("input") && ($("#input").val() != "") && ($("#input").val() != "METHOD NOT ALLOWED")) {
            inputText = $('#input').val()
            // console.log(currentDisplay[currentDisplay.active][side_full_name][0])
            // console.log({ "from/to": "INPUT TIME" })
            item = currentDisplay[currentDisplay.active][side_full_name][number - 1]
            currentDisplay[currentDisplay.active][side_full_name][number - 1][Object.keys(item)[0]] = inputText
            // console.log(currentDisplay)
            display2.text(inputText)
            //Clear input
            $("#input").val("")
        }
        else {
            // If option is an Input
            // Page - Specific Tasks
            switch ($("#pageName").html()) {
                case "takeoff":
                    chosenDisplay = currentDisplay.takeoff[side_full_name][number - 1]
                    if (side == 'l') {
                        if (Object.keys(chosenDisplay)[0].includes("*")) {
                            title = Object.keys(chosenDisplay)[0];
                            content = chosenDisplay[title]
                            delete chosenDisplay[title];
                            chosenDisplay[title.substr(0, title.length - 1)] = content;
                        }
                        else {
                            title = Object.keys(chosenDisplay)[0];
                            content = chosenDisplay[title]
                            delete chosenDisplay[title];
                            chosenDisplay[title + "*"] = content;
                        }
                        reloadContent();
                    }
                    else {
                        if (Object.keys(chosenDisplay)[0].includes("RTO")) {
                            // Tally the point in currentDisplay
                            // Loop through the whole dictionary of takeoff left
                            totalPoint = 0;
                            // console.log(Object.keys(currentDisplay.takeoff.left).length)
                            for (i = 0; i < Object.keys(currentDisplay.takeoff.left).length; i++) {
                                key = Object.keys(currentDisplay.takeoff.left[i]);
                                data = currentDisplay.takeoff.left[i][key]
                                completed = key[0].includes("*")
                                if (completed)
                                    totalPoint += parseInt(data.substr(data.indexOf("/") + 1));
                                // console.log(totalPoint)
                                // console.log(key)
                                // console.log(data)
                            }
                            // if key of the item in the dictionary include *, get the point that it represent
                            // add point that it represent 

                            currentDisplay.backendActionRequest = totalPoint
                            $.ajax({
                                url: "/api/addPoints",
                                data: JSON.stringify(currentDisplay),
                                success: function (response) {
                                    alert("Submitted")
                                },
                            });

                        }
                    }
                    break
                case "t/oappr":
                    if (display1.html() == "to") {
                        // Update Screen
                        if (currentDisplay["perf"] != undefined) {
                            currentDisplay["takeoff"] = {
                                "left": {

                                },
                                "right": {
                                    0: { "RTO": "submit" }
                                }
                            }
                            currentDisplay["takeoff"]["left"][0] = currentDisplay["perf"]["left"][4]
                            for (i = 0; i < currentDisplay["perf"]["right"].length; i += 1) {
                                currentDisplay["takeoff"]["left"][i + 1] = currentDisplay["perf"]["right"][i]
                            }
                            //Switch Active Page to takeoff Page
                            currentDisplay.active = "takeoff";
                            reloadContent();
                        }
                        else {
                            $("#input").val("Please Init Performance Page")
                        }
                    }
                    else if (display1.html() == "appr") {
                        // Get Points for today
                        // Loop through currentDisplay["f_pln"]
                        tasks = currentDisplay.f_pln.left
                        keys = Object.keys(tasks)
                        totalPoints = 0

                        // Get penalties for each scenario
                        penalties = currentDisplay.init.left["1"]["altn"]
                        one = penalties.substr(0, getPosition(penalties, "/", 1))
                        two = penalties.substr(getPosition(penalties, "/", 1) + 1, getPosition(penalties, "/", 1))
                        three = penalties.substr(getPosition(penalties, "/", 2) + 1)
                        for (i = 1; i < tasks.length; i++) {
                            item = tasks[keys[i]][""]
                            points = parseInt(item.substr(item.indexOf("/") + 1).replace("*", "").replace("!", "").replace("-", "").replace("+", ""))
                            console.log(item)
                            console.log(points)
                            if (item.includes("*")) {
                                totalPoints += points
                            }
                            else if (item.includes("-")) {
                                totalPoints += points * one
                            }
                            else if (item.includes("+")) {
                                totalPoints += points * two
                            }
                            else if (item.includes("!")) {
                                totalPoints += points * three
                            }
                        }
                        currentDisplay.backendActionRequest = totalPoints
                        // Set appr of currentdisplay:
                        currentDisplay["appr"] = {
                            "left": [
                                currentDisplay.fuel.left[0],
                                currentDisplay.init.left[3],
                                currentDisplay.init.left[2]
                            ],
                            "right": [
                                { "Points Today": totalPoints },
                                { "land": "" }
                            ]
                        }
                        currentDisplay.active = "appr"
                        reloadContent()
                        saveContent()
                        // TODO: Handle Approach
                    }
                    break;
                case "f_pln":
                    console.log($("#lb" + number).html())
                    task = $("#lb" + number).html()

                    if (display1.html() == "insert" || display1.html() == "erase") {
                        confirmation("", display1.html(), function (theDisplay) {
                            // Get differences between time now and next task's time:
                            d1 = Date.now();
                            current = currentDisplay.f_pln.left[theDisplay - 1 + position]
                            currentThing = current[Object.keys(current)[0]]
                            try {
                                next = currentDisplay.f_pln.left[parseInt(theDisplay) + position]
                                nextThing = next[Object.keys(next)[0]]
                                nextThing = nextThing.replace("*", "").replace("!", "").replace("-", "").replace("+", "")
                                nextThing = nextThing.substr(0, nextThing.indexOf("/"))
                                request = { "task": nextThing }
                                console.log(request)
                                $.ajax({
                                    url: "api/getDueDate",
                                    data: JSON.stringify(request),
                                    success: function (response) {
                                        d2 = new Date(response).getTime()
                                        difference = d2 - d1
                                        console.log(response)
                                        console.log(difference)
                                        // If Late
                                        if (difference < 0) {
                                            absoluteD = Math.abs(difference)
                                            if (absoluteD < 1200000) {
                                                currentDisplay.f_pln.left[theDisplay - 1 + position] = { "": currentThing + "-" }
                                            }
                                            else if (absoluteD > 1200000 && absoluteD < 3600000) {
                                                currentDisplay.f_pln.left[theDisplay - 1 + position] = { "": currentThing + "+" }
                                            }
                                            else {
                                                currentDisplay.f_pln.left[theDisplay - 1 + position] = { "": currentThing + "!" }
                                            }
                                        }
                                        else {
                                            currentDisplay.f_pln.left[theDisplay - 1 + position] = { "": currentThing + "*" }
                                        }
                                        reloadContent()
                                        saveContent()
                                    }
                                })
                            }
                            catch {
                                currentDisplay.f_pln.left[theDisplay - 1 + position] = { "": currentThing + "*" }
                                reloadContent()
                                saveContent()
                                // if this is the last task of the day
                            }
                        })
                    }
                    else if (task != "" && !(task.includes("!") || task.includes("*") || task.includes("-") || task.includes("+"))) {
                        // If there is a task, prompt the user to confirm, upon confirmation, add a start to the end of the task to mark it off.
                        confirmation(undefined, undefined, undefined, number)
                    }
                    break;
                case "appr":
                    if (display1.html() == "land") {
                        console.log(currentDisplay.appr.right[0]["Points Today"])
                        confirmation(undefined, undefined, undefined, currentDisplay.appr.right[0]["Points Today"])
                    }
                    else if (display1.html() == "insert" || display1.html() == "empty") {
                        console.log("Hi")
                        confirmation("", "insert", function () {
                            $.ajax({
                                url: "/api/addPoints",
                                data: JSON.stringify(currentDisplay),
                                success: function (response) {
                                    for (i = 1; i < currentDisplay.f_pln.left.length; i++) {
                                        theTask = currentDisplay.f_pln.left[i][""]
                                        if (theTask.includes("*") || theTask.includes("*") || theTask.includes("-") || theTask.includes("+")) {
                                            currentDisplay.info[i] = theTask.substr(0, theTask.indexOf("/"))
                                        }
                                    }
                                    console.log(currentDisplay.info)
                                    $.ajax({
                                        url: "/api/deleteTask",
                                        data: JSON.stringify(currentDisplay),
                                        success: function (response) {
                                            console.log("DELETED Tasks and added points")
                                            currentDisplay.active = "init"
                                            saveContent()
                                            reloadContent()
                                        },
                                    });
                                },
                            });
                        })
                    }
            }
        }
        saveContent()
        return false;
        // send request to backend depending on which class it is
    })


    $("#reset").click(function () {
        for (const [key, value] of Object.entries(airplaneModes)) {
            currentDisplay[key] = airplaneModes[key]
        }
        currentDisplay[takeoff] = {}
        saveContent()
        reloadContent()
    })

    $("#loadwaypoint").click(function () {
        $.ajax({
            url: "/api/get_tasks",
            data: JSON.stringify(currentDisplay),
            success: function (response) {
                console.log('OH F')
                // Get the response into MCDU Display
                // Reset MCDU Display
                currentDisplay.dir = airplaneModes.dir;
                currentDisplay.f_pln = airplaneModes.f_pln;
                for (i = 0; i < response.length; i++) {
                    // Add this specific task
                    // Get Time in the day
                    time = response[i].deadline
                    timeOfDay = time.substr(time.indexOf("T") + 1)
                    console.log(response[i]["points"])
                    currentDisplay.dir.left[i + 2] = { "": response[i]["name"] + "/" + response[i]["points"] }
                    currentDisplay.dir.right[i + 2] = { "at": timeOfDay }
                    currentDisplay.f_pln.left[i + 1] = { "": response[i]["name"] + "/" + response[i]["points"] }
                    currentDisplay.f_pln.right[i + 1] = { "": timeOfDay }
                }
                saveContent()
                reloadContent()
            },
        });
    })
</script>
{% endblock %}

{% block style %}
<style>
    .overlay {
        position: absolute;
    }

    .mcduArrow {
        width: 5.5vh;
        height: 3.5vh;
    }

    .mcduSideButton {
        width: 5vh;
        height: 3vh;
    }

    .menuButton {
        width: 6vh;
        height: 4vh;
    }

    .mcduSideButton,
    .menuButton,
    .mcduArrow,
    .mcduNumber,
    .mcduLetter,
    #input {
        background: transparent;
        border: none !important;
        z-index: 10;
    }

    .display {
        text-transform: uppercase;
        color: green;
    }
</style>
{% endblock %}